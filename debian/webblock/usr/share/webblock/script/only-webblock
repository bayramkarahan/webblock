#!/usr/bin/env bash
# only-webblock
# GeÃ§ici tek domain filtreleme - NetSentinel'e dokunmaz

IPT="/usr/sbin/iptables-legacy"
IPT6="/usr/sbin/ip6tables-legacy"
CHAIN="temp_web_filter"
STATE_FILE="/tmp/only_webblock_state"
NETSENTINEL_SERVICE="webblock.service"

start_filter() {
    local domain="$1"

    # EÄŸer zaten aktifse uyar
    if [ -f "$STATE_FILE" ]; then
        current=$(cat "$STATE_FILE")
        if [ "$current" == "$domain" ]; then
            echo "âš ï¸ Filtre zaten aktif: sadece $domain eriÅŸilebilir."
            return 0
        else
            echo "ğŸ”„ FarklÄ± domain aktif ($current). Ã–nce stop yapÄ±lÄ±yor..."
            stop_filter
        fi
    fi

    echo "ğŸ›‘ $NETSENTINEL_SERVICE servisi durduruluyor..."
    systemctl stop "$NETSENTINEL_SERVICE" 2>/dev/null || true

    echo "ğŸŒ $domain IP adresi Ã§Ã¶zÃ¼lÃ¼yor..."
    ip4=$(getent ahostsv4 "$domain" | awk '{print $1; exit}')
    ip6=$(getent ahostsv6 "$domain" | awk '{print $1; exit}')

    if [ -z "$ip4" ] && [ -z "$ip6" ]; then
        echo "âŒ IP adresi Ã§Ã¶zÃ¼lemedi: $domain"
        exit 1
    fi

    echo "ğŸ§± $CHAIN zinciri oluÅŸturuluyor..."
    # Zincir zaten varsa Ã¶nce temizle
    $IPT -F $CHAIN 2>/dev/null || true
    $IPT6 -F $CHAIN 2>/dev/null || true

    $IPT -N $CHAIN 2>/dev/null || true
    $IPT6 -N $CHAIN 2>/dev/null || true

    # IPv4 izin + engelleme
    if [ -n "$ip4" ]; then
        $IPT -A $CHAIN -d "$ip4" -j ACCEPT
    fi
    $IPT -A $CHAIN -j DROP

    # IPv6 izin + engelleme
    if [ -n "$ip6" ]; then
        $IPT6 -A $CHAIN -d "$ip6" -j ACCEPT
    fi
    $IPT6 -A $CHAIN -j DROP

    # OUTPUTâ€™a ekle (zaten ekli deÄŸilse)
    if ! $IPT -C OUTPUT -j $CHAIN 2>/dev/null; then
        $IPT -I OUTPUT -j $CHAIN
    fi
    if ! $IPT6 -C OUTPUT -j $CHAIN 2>/dev/null; then
        $IPT6 -I OUTPUT -j $CHAIN
    fi

    echo "$domain" > "$STATE_FILE"
    echo "âœ… Filtre etkin: sadece $domain eriÅŸilebilir."
}

stop_filter() {
    echo "ğŸ”„ Filtre kaldÄ±rÄ±lÄ±yor..."
    $IPT -D OUTPUT -j $CHAIN 2>/dev/null || true
    $IPT6 -D OUTPUT -j $CHAIN 2>/dev/null || true
    $IPT -F $CHAIN 2>/dev/null || true
    $IPT6 -F $CHAIN 2>/dev/null || true
    $IPT -X $CHAIN 2>/dev/null || true
    $IPT6 -X $CHAIN 2>/dev/null || true
    rm -f "$STATE_FILE"
    echo "âœ… Filtre devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±."

    echo "ğŸš€ $NETSENTINEL_SERVICE yeniden baÅŸlatÄ±lÄ±yor..."
    systemctl start "$NETSENTINEL_SERVICE" 2>/dev/null || true
}

status_filter() {
    if [ -f "$STATE_FILE" ]; then
        domain=$(cat "$STATE_FILE")
        echo "ğŸŒ Filtre aktif: sadece $domain eriÅŸilebilir."
    else
        echo "âšª Filtre devre dÄ±ÅŸÄ±."
    fi
}

case "$1" in
    start)
        if [ -z "$2" ]; then
            echo "KullanÄ±m: $0 start <domain>"
            exit 1
        fi
        start_filter "$2"
        ;;
    stop)
        stop_filter
        ;;
    status)
        status_filter
        ;;
    *)
        echo "KullanÄ±m: $0 {start|stop|status} [domain]"
        exit 1
        ;;
esac

