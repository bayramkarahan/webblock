#!/usr/bin/env bash
set -euo pipefail

# --- legacy switching (varsa) ---
if [ -x /usr/sbin/iptables-legacy ]; then
  echo "Switching iptables -> iptables-legacy"
  sudo update-alternatives --set iptables /usr/sbin/iptables-legacy || true
else
  echo "/usr/sbin/iptables-legacy not found; leaving iptables as-is"
fi

if [ -x /usr/sbin/ip6tables-legacy ]; then
  echo "Switching ip6tables -> ip6tables-legacy"
  sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy || true
else
  echo "/usr/sbin/ip6tables-legacy not found; leaving ip6tables as-is"
fi

# ipset'lerin varlığını garanti et (mevcutsa hata verme)
sudo ipset create blocklist hash:ip -exist
sudo ipset create blocklist6 hash:ip family inet6 -exist

# IPv6 kullanımda mı? (0 = enabled, 1 = disabled)
IPV6_DISABLED=$(cat /proc/sys/net/ipv6/conf/all/disable_ipv6 2>/dev/null || echo 1)
if [ "$IPV6_DISABLED" -eq 1 ]; then
  echo "IPv6 appears disabled (skip ip6tables parts). To enable: sudo sysctl -w net.ipv6.conf.all.disable_ipv6=0"
  SKIP_IPV6=true
else
  SKIP_IPV6=false
fi

# Zincir ismi (istediğin gibi değiştir)
CHAIN="NETSENTINEL_TEMP"
CHAIN6="NETSENTINEL_TEMP6"

# Kullanılacak araçlar (update-alternatives ile sistem ayarlanmışsa bunlar legacy'yi gösterir)
IPT=$(command -v iptables || true)
IPT6=$(command -v ip6tables || true)

# Fallback defaults
: "${IPT:=iptables}"
: "${IPT6:=ip6tables}"

echo "Using IPT=$IPT IPT6=$IPT6"

# 1) Zincirleri oluştur (varsa hata verme)
$IPT -N $CHAIN 2>/dev/null || true
if [ "$SKIP_IPV6" = false ]; then
  $IPT6 -N $CHAIN6 2>/dev/null || true
fi

# 2) Zincirleri temizle (var olan kuralları sıfırla)
$IPT -F $CHAIN
if [ "$SKIP_IPV6" = false ]; then
  $IPT6 -F $CHAIN6
fi

# 3) Zincir içine güvenli kurallar ekle
# IPv4
$IPT -A $CHAIN -o lo -j ACCEPT
$IPT -A $CHAIN -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
$IPT -A $CHAIN -p udp --dport 53 -j ACCEPT
$IPT -A $CHAIN -p tcp --dport 53 -j ACCEPT
# Drop HTTP/HTTPS (TCP)
$IPT -A $CHAIN -p tcp --dport 80 -j DROP
$IPT -A $CHAIN -p tcp --dport 443 -j DROP
# Drop UDP on those ports (QUIC over 443 uses UDP)
$IPT -A $CHAIN -p udp --dport 80 -j DROP
$IPT -A $CHAIN -p udp --dport 443 -j DROP

# IPv6 (sadece etkinse)
if [ "$SKIP_IPV6" = false ]; then
  $IPT6 -A $CHAIN6 -o lo -j ACCEPT
  $IPT6 -A $CHAIN6 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  $IPT6 -A $CHAIN6 -p udp --dport 53 -j ACCEPT
  $IPT6 -A $CHAIN6 -p tcp --dport 53 -j ACCEPT

  $IPT6 -A $CHAIN6 -p tcp --dport 80 -j DROP
  $IPT6 -A $CHAIN6 -p tcp --dport 443 -j DROP
  $IPT6 -A $CHAIN6 -p udp --dport 80 -j DROP
  $IPT6 -A $CHAIN6 -p udp --dport 443 -j DROP
fi

# 4) OUTPUT zincirinin başına jump ekle (önce varsa sil, tekrar eklemeyi engelle)
$IPT -D OUTPUT -j $CHAIN 2>/dev/null || true
$IPT -I OUTPUT 1 -j $CHAIN

if [ "$SKIP_IPV6" = false ]; then
  $IPT6 -D OUTPUT -j $CHAIN6 2>/dev/null || true
  $IPT6 -I OUTPUT 1 -j $CHAIN6
fi

echo "NETSENTINEL_TEMP installed. HTTP/HTTPS (tcp+udp ports 80/443) are now blocked (v4${SKIP_IPV6:+ only},$( [ "$SKIP_IPV6" = false ] && echo " v6" || true ))."

