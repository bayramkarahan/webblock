#!/bin/bash
# Tek domain eriÅŸimi saÄŸlayan geÃ§ici web filtreleme scripti
# KullanÄ±m:
#   ./webfilter.sh start example.com
#   ./webfilter.sh stop

CHAIN_NAME="temp_web_filter"
NETSENTINEL_SERVICE="webblock.service"

start_filter() {
    DOMAIN="$1"

    if [ -z "$DOMAIN" ]; then
        echo "âŒ Hata: Domain belirtilmedi!"
        echo "KullanÄ±m: $0 start example.com"
        exit 1
    fi

    echo "ğŸ›‘ NetSentinel servisi durduruluyor..."
    systemctl stop "$NETSENTINEL_SERVICE" 2>/dev/null

    echo "ğŸŒ $DOMAIN IP adresi Ã§Ã¶zÃ¼lÃ¼yor..."
    IPs=$(getent ahosts "$DOMAIN" | awk '{print $1}' | sort -u)
    if [ -z "$IPs" ]; then
        echo "âŒ $DOMAIN iÃ§in IP bulunamadÄ±!"
        exit 1
    fi

    echo "ğŸ§± $CHAIN_NAME zinciri oluÅŸturuluyor..."
    iptables -N "$CHAIN_NAME" 2>/dev/null
    ip6tables -N "$CHAIN_NAME" 2>/dev/null

    # Eski kurallar varsa temizle
    iptables -F "$CHAIN_NAME"
    ip6tables -F "$CHAIN_NAME"

    echo "ğŸš« TÃ¼m trafiÄŸi engelle, sadece $DOMAIN'e izin veriliyor..."
    # IPv4 iÃ§in
    for ip in $IPs; do
        iptables -A "$CHAIN_NAME" -d "$ip" -j ACCEPT
    done
    iptables -A "$CHAIN_NAME" -j DROP

    # IPv6 iÃ§in
    for ip in $IPs; do
        ip6tables -A "$CHAIN_NAME" -d "$ip" -j ACCEPT
    done
    ip6tables -A "$CHAIN_NAME" -j DROP

    # FORWARD ve OUTPUT zincirine ekle
    iptables -I OUTPUT -j "$CHAIN_NAME"
    ip6tables -I OUTPUT -j "$CHAIN_NAME"

    echo "âœ… Filtre etkin: sadece $DOMAIN eriÅŸilebilir."
}

stop_filter() {
    echo "â™»ï¸ $CHAIN_NAME kaldÄ±rÄ±lÄ±yor ve NetSentinel yeniden baÅŸlatÄ±lÄ±yor..."

    iptables -D OUTPUT -j "$CHAIN_NAME" 2>/dev/null
    ip6tables -D OUTPUT -j "$CHAIN_NAME" 2>/dev/null

    iptables -F "$CHAIN_NAME" 2>/dev/null
    ip6tables -F "$CHAIN_NAME" 2>/dev/null

    iptables -X "$CHAIN_NAME" 2>/dev/null
    ip6tables -X "$CHAIN_NAME" 2>/dev/null

    echo "ğŸš€ NetSentinel yeniden baÅŸlatÄ±lÄ±yor..."
    systemctl start "$NETSENTINEL_SERVICE" 2>/dev/null

    echo "âœ… Filtre kaldÄ±rÄ±ldÄ±, sistem normale dÃ¶ndÃ¼."
}

case "$1" in
    start)
        start_filter "$2"
        ;;
    stop)
        stop_filter
        ;;
    *)
        echo "KullanÄ±m:"
        echo "  $0 start example.com  â†’ sadece bu domaine izin verir"
        echo "  $0 stop               â†’ filtreyi kaldÄ±rÄ±r ve NetSentinelâ€™i yeniden baÅŸlatÄ±r"
        ;;
esac

